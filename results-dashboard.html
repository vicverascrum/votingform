<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Resultados Sprint 24</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', Arial, sans-serif; background: #f8f9fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 0.9rem; }
        .results-section { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { opacity: 0.9; }
        .table-container { overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .results-table th { background: #f8f9fa; font-weight: 600; }
        .capacity-bar { width: 100px; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .capacity-fill { height: 100%; transition: width 0.3s ease; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin: 20px 0; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 6px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard Sprint 24</h1>
            <p>Resultados en tiempo real de la votaci√≥n de priorizaci√≥n</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalSubmissions">-</div>
                <div class="stat-label">Total Votaciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgHours">-</div>
                <div class="stat-label">Promedio Horas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgCapacity">-</div>
                <div class="stat-label">Capacidad Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="maxHours">-</div>
                <div class="stat-label">M√°ximo Horas</div>
            </div>
        </div>

        <div class="results-section">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadResults()">üîÑ Actualizar</button>
                <button class="btn btn-secondary" onclick="exportCSV()">üìä Exportar CSV</button>
                <button class="btn btn-secondary" onclick="loadStats()">üìà Estad√≠sticas</button>
            </div>

            <div id="status"></div>

            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Email</th>
                            <th>Items Seleccionados</th>
                            <th>Total Horas</th>
                            <th>Capacidad</th>
                            <th>% Uso</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="6" class="loading">Cargando resultados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://dubo90gxce.execute-api.us-east-1.amazonaws.com/prod';
        
        // Load results on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
            loadStats();
            
            // Auto-refresh every 30 seconds
            setInterval(loadResults, 30000);
        });

        async function loadResults() {
            try {
                showStatus('Cargando resultados...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/query?type=results`);
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data.data);
                    showStatus(`‚úÖ ${data.count} resultados cargados`, 'success');
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error loading results:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('resultsBody').innerHTML = 
                    '<tr><td colspan="6">Error al cargar resultados</td></tr>';
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/query?type=stats`);
                const data = await response.json();
                
                if (data.success) {
                    displayStats(data.stats);
                }
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            
            if (!results || results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No hay resultados disponibles</td></tr>';
                return;
            }
            
            tbody.innerHTML = results.map(result => {
                const date = new Date(result.submission_date).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const capacityColor = getCapacityColor(result.capacity_percentage);
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td>${result.email}</td>
                        <td title="${result.selected_items_list}">
                            ${result.items_selected} items
                        </td>
                        <td>${result.total_hours}h</td>
                        <td>
                            <div class="capacity-bar">
                                <div class="capacity-fill" 
                                     style="width: ${Math.min(result.capacity_percentage, 100)}%; background: ${capacityColor}">
                                </div>
                            </div>
                        </td>
                        <td>${result.capacity_percentage.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }

        function displayStats(stats) {
            document.getElementById('totalSubmissions').textContent = stats.total_submissions || 0;
            document.getElementById('avgHours').textContent = Math.round(stats.avg_hours || 0) + 'h';
            document.getElementById('avgCapacity').textContent = Math.round(stats.avg_capacity || 0) + '%';
            document.getElementById('maxHours').textContent = (stats.max_hours || 0) + 'h';
        }

        function getCapacityColor(percentage) {
            if (percentage > 100) return '#dc3545';
            if (percentage > 80) return '#fd7e14';
            if (percentage > 50) return '#ffc107';
            return '#007bff';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        function exportCSV() {
            const table = document.querySelector('.results-table');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            const csv = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
            }).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sprint24-results-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
